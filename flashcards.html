<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plataforma de Estudo - Instrumentos Cir√∫rgicos</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0f4c81, #1e88e5);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.app {
  width: min(980px, 100%);
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.22);
  padding: 24px;
}
h1 { margin: 0 0 8px; color: #0f4c81; }
.subtitle { margin: 0 0 14px; color: #3f6e98; }
.toolbar { display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px; }
.mode-btn, .difficulty-btn, .action-btn, .option-btn {
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: .2s;
  font-weight: 700;
}
.session-select {
  background: #e3f2fd;
  color: #0f4c81;
  padding: 8px 10px;
  border: none;
  border-radius: 10px;
  font-weight: 700;
}
.goal-input {
  width: 84px;
  background: #e3f2fd;
  color: #0f4c81;
  padding: 8px 10px;
  border: none;
  border-radius: 10px;
  font-weight: 700;
}
.goal-label {
  color: #0f4c81;
  font-weight: 700;
}
.toggle-active {
  background: #0f4c81 !important;
  color: #fff !important;
}
.mode-btn, .difficulty-btn {
  background: #e3f2fd;
  color: #0f4c81;
  padding: 8px 12px;
}
.mode-btn.active, .difficulty-btn.active { background: #0f4c81; color: #fff; }
.difficulty-group { display: flex; gap: 6px; flex-wrap: wrap; }
.primary-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.config-panel {
  border: 1px solid #d9e8f8;
  border-radius: 10px;
  background: #f8fcff;
  padding: 8px 10px;
}
.config-panel summary {
  cursor: pointer;
  color: #0f4c81;
  font-weight: 700;
}
.config-body {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.config-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.stats { color: #0f4c81; font-weight: 600; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 12px; }
.meta-chip {
  margin: 2px 0 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #e9f4ff;
  color: #0f4c81;
  border: 1px solid #d2e7fb;
  border-radius: 999px;
  padding: 6px 12px;
  font-weight: 700;
}
.progress-wrap { width: 100%; height: 10px; background: #dbe8f5; border-radius: 999px; overflow: hidden; margin-bottom: 12px; }
.progress-bar { width: 0%; height: 100%; background: #1e88e5; transition: width .35s ease; }
.timer { color: #d32f2f; font-weight: 700; margin-bottom: 10px; }
.hidden { display: none; }
.card {
  min-height: 380px;
  border: 2px solid #e6f0fb;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.visual {
  width: 250px;
  height: 185px;
  border: 1px solid #cfe3f7;
  border-radius: 12px;
  background: #f2f8ff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  padding: 8px;
  color: #4c7399;
  font-weight: 700;
  margin-bottom: 12px;
}
.visual img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
.title { margin: 0; color: #0f4c81; }
.desc { margin: 7px 0 0; color: #3a668f; }
.controls { margin-top: 14px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.action-btn { background: #0f4c81; color: #fff; padding: 9px 14px; }
.options { width: min(460px, 100%); }
.option-btn {
  width: 100%;
  margin: 6px 0;
  padding: 10px;
  background: #e3f2fd;
  color: #0f4c81;
}
.option-btn:hover { background: #cde7ff; }
.correct { background: #43a047 !important; color: #fff !important; }
.wrong { background: #e53935 !important; color: #fff !important; }
.feedback { min-height: 24px; margin-top: 8px; font-weight: 700; color: #0f4c81; }
.list-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
  gap: 12px;
  width: 100%;
}
.list-item {
  border: 1px solid #d9e8f8;
  border-radius: 12px;
  padding: 10px;
  background: #fbfdff;
  text-align: left;
}
.list-item .front, .list-item .back { font-size: 12px; color: #39648b; font-weight: 700; margin-bottom: 6px; }
.list-item .mini {
  width: 100%;
  height: 120px;
  border: 1px solid #e1ecf8;
  border-radius: 10px;
  background: #f3f8ff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-bottom: 8px;
  color: #4c7399;
  font-weight: 700;
  text-align: center;
  padding: 6px;
}
.list-item .mini img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
.list-item h4 { margin: 0 0 4px; color: #0f4c81; font-size: 14px; }
.list-item p { margin: 0; color: #3a668f; font-size: 12px; }
.zoom-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.82);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 9999;
}
.zoom-overlay.open { display: flex; }
.zoom-content {
  max-width: min(1000px, 95vw);
  max-height: 90vh;
  text-align: center;
}
.zoom-img {
  max-width: 100%;
  max-height: calc(90vh - 40px);
  object-fit: contain;
  border-radius: 12px;
  background: #fff;
}
.zoom-caption {
  color: #fff;
  margin-top: 8px;
  font-weight: 700;
}
.welcome-screen {
  border: 2px solid #e6f0fb;
  border-radius: 16px;
  padding: 26px;
  background: linear-gradient(180deg, #f8fcff, #eef6ff);
  text-align: center;
  margin-bottom: 12px;
}
.welcome-title {
  margin: 0 0 8px;
  color: #0f4c81;
}
.welcome-text {
  margin: 0 0 16px;
  color: #3a668f;
}
.welcome-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}
.start-btn {
  background: #0f4c81;
  color: #fff;
  padding: 10px 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 700;
}
</style>
</head>
<body>
<div class="app">
  <h1>Instrumentos Cir√∫rgicos</h1>
  <p class="subtitle">Escolha o modo de estudo para come√ßar.</p>

  <div id="welcomeScreen" class="welcome-screen">
    <h2 class="welcome-title">Como voc√™ quer estudar hoje?</h2>
    <p class="welcome-text">Selecione um modo para iniciar: flashcards, quiz ou lista completa.</p>
    <div class="welcome-actions">
      <button class="start-btn" type="button" onclick="startStudy('flashcard')">Flashcards</button>
      <button class="start-btn" type="button" onclick="startStudy('quiz')">Quiz</button>
      <button class="start-btn" type="button" onclick="startStudy('lista')">Lista</button>
    </div>
  </div>

  <div id="studyArea" class="hidden">

  <div class="toolbar">
    <div class="primary-row">
      <button id="flashModeBtn" class="mode-btn active" type="button" onclick="setMode('flashcard')">Flashcards</button>
      <button id="quizModeBtn" class="mode-btn" type="button" onclick="setMode('quiz')">Quiz</button>
      <button id="listModeBtn" class="mode-btn" type="button" onclick="setMode('lista')">Lista</button>
      <button class="mode-btn" type="button" onclick="resetAnalise()">Resetar an√°lise</button>
    </div>

    <details class="config-panel">
      <summary>Configura√ß√µes da sess√£o</summary>
      <div class="config-body">
        <div class="config-row">
          <select id="groupFilter" class="session-select" onchange="setGroupFilter()">
            <option value="all" selected>Grupo: Todos</option>
            <option value="Preens√£o">Preens√£o</option>
            <option value="Hemostasia">Hemostasia</option>
            <option value="Exposi√ß√£o">Exposi√ß√£o</option>
            <option value="Especiais">Especiais</option>
            <option value="Porta-Agulhas">Porta-Agulhas</option>
          </select>
          <button id="favoritesBtn" class="mode-btn" type="button" onclick="toggleOnlyFavorites()">Favoritos</button>
          <button id="lastErrorsBtn" class="mode-btn" type="button" onclick="toggleOnlyLastErrors()">S√≥ erros (√∫ltima sess√£o)</button>
        </div>

        <div class="config-row">
          <select id="sessionSize" class="session-select" onchange="applySessionSize(true)">
            <option value="10">10 cards</option>
            <option value="20" selected>20 cards</option>
            <option value="40">40 cards</option>
            <option value="60">60 cards</option>
            <option value="all">Todos</option>
          </select>
          <span class="goal-label">Meta di√°ria:</span>
          <input id="dailyGoalInput" class="goal-input" type="number" min="1" step="1" value="30" onchange="updateDailyGoal()" title="Meta di√°ria de cards">
          <button class="mode-btn" type="button" onclick="applySessionSize(true)">Sortear sess√£o</button>
        </div>

        <div class="config-row difficulty-group" id="difficultyGroup">
          <select id="quizType" class="session-select" onchange="setQuizType()">
            <option value="tempo" selected>Quiz: Tempo</option>
            <option value="nome">Quiz: Nome</option>
          </select>
          <button id="facilBtn" class="difficulty-btn" type="button" onclick="setDifficulty('facil')">F√°cil</button>
          <button id="medioBtn" class="difficulty-btn active" type="button" onclick="setDifficulty('medio')">M√©dio</button>
          <button id="dificilBtn" class="difficulty-btn" type="button" onclick="setDifficulty('dificil')">Dif√≠cil</button>
        </div>
      </div>
    </details>
  </div>

  <div class="stats" id="stats"></div>
  <div class="meta-chip" id="dailyGoalChip">üéØ Meta di√°ria: 30 cards</div>
  <div class="progress-wrap"><div class="progress-bar" id="progressBar"></div></div>
  <div id="timer" class="timer hidden">Tempo: 15s</div>
  <div id="card" class="card"></div>
  </div>
</div>

<div id="zoomOverlay" class="zoom-overlay" onclick="closeZoom()">
  <div class="zoom-content" onclick="event.stopPropagation()">
    <img id="zoomImg" class="zoom-img" alt="Zoom">
  </div>
</div>

<script>
const instrumentos = [
  { nome: "Pin√ßa Adson", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/adson 1.jpg" },
  { nome: "Pin√ßa Adson", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/adson 2.jpg" },
  { nome: "Pin√ßa Adson", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/adson 3.jpg" },
  { nome: "Pin√ßa Anat√¥mica", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/anatomica 1.webp" },
  { nome: "Pin√ßa Anat√¥mica", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/anatomica 2.webp" },
  { nome: "Pin√ßa Dente de Rato", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/dente de rato 1.webp" },
  { nome: "Pin√ßa Dente de Rato", tempo: "Preens√£o", grupo: "Preens√£o", imagem: "imagens/dente de rato 2.jpg" },

  { nome: "Pin√ßa Crile", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/crile 1.webp" },
  { nome: "Pin√ßa Crile", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/crile 2.webp" },
  { nome: "Pin√ßa Crile", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/crile 3.webp" },
  { nome: "Pin√ßa Halstead", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/halstead 1.webp" },
  { nome: "Pin√ßa Halstead", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/halstead 2.webp" },
  { nome: "Pin√ßa Halstead", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/halstead 3.png" },
  { nome: "Pin√ßa Kelly", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kelly 1.webp" },
  { nome: "Pin√ßa Kelly", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kelly 2.jpg" },
  { nome: "Pin√ßa Kelly", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kelly 3.webp" },
  { nome: "Pin√ßa Mixter", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/mixter 1.webp" },
  { nome: "Pin√ßa Mixter", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/mixter 2.webp" },
  { nome: "Pin√ßa Mixter", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/mixter 3.jpg" },

  { nome: "Farabeuf", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/farabeuf 1.jpg" },
  { nome: "Farabeuf", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/farabeuf 2.jpg" },
  { nome: "Farabeuf", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/farabeuf 3.jpg" },
  { nome: "V√°lvula Male√°vel", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/valvula maleavel 1.jfif" },
  { nome: "V√°lvula Male√°vel", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/valvula maleavel 2.webp" },
  { nome: "Doyen", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/doyen 1.webp" },
  { nome: "Doyen", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/doyen 2.webp" },
  { nome: "Doyen", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/doyen 3.webp" },
  { nome: "Deaver", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/deaver 1.webp" },
  { nome: "Deaver", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/deaver 2.webp" },
  { nome: "Deaver", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Din√¢micos", imagem: "imagens/deaver 3.webp" },

  { nome: "Gosset", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/gosset.webp" },
  { nome: "Gosset", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/gosset 2.webp" },
  { nome: "Gosset", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/gosset 3.webp" },
  { nome: "Balfour", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/balfour 1.webp" },
  { nome: "Balfour", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/balfour 2.webp" },
  { nome: "Balfour", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/balfour 3.webp" },
  { nome: "Finochietto", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/finochietto 1.png" },
  { nome: "Finochietto", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/finochietto 2.webp" },
  { nome: "Finochietto", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/finochietto 3.webp" },
  { nome: "Afastador Adson", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/afastador adson 1.webp" },
  { nome: "Afastador Adson", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/afastador adson 2.jpg" },
  { nome: "Afastador Adson", tempo: "Exposi√ß√£o", grupo: "Exposi√ß√£o Auto-est√°ticos", imagem: "imagens/afastador adson 3.webp" },

  { nome: "Allis", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/allis 1.webp" },
  { nome: "Allis", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/allis 2.png" },
  { nome: "Allis", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/allis 3.webp" },
  { nome: "Babcock", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/babcock 1.webp" },
  { nome: "Babcock", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/babcock 2.webp" },
  { nome: "Babcock", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/babcock 3.jpg" },
  { nome: "Backaus", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/backaus 1.jpg" },
  { nome: "Backaus", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/backaus 2.webp" },
  { nome: "Backaus", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/backaus 3.webp" },
  { nome: "Cureta de Siemens", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/cureta de siemens 1.jpg" },
  { nome: "Cureta de Siemens", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/cureta de siemens 2.jpg" },
  { nome: "Duval", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/duval 1.webp" },
  { nome: "Duval", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/duval 2.webp" },
  { nome: "Duval", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/duval 3.webp" },
  { nome: "Pin√ßa Kocher", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kocher 1.jpg" },
  { nome: "Pin√ßa Kocher", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kocher 2.webp" },
  { nome: "Pin√ßa Kocher", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kocher 3.jpg" },
  { nome: "Pin√ßa Kocher", tempo: "Hemostasia", grupo: "Hemost√°ticas", imagem: "imagens/kocher 4.webp" },
  { nome: "Potts", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/potts 1.jpg" },
  { nome: "Potts", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/potts 2.webp" },
  { nome: "Potts", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/potts 3.webp" },
  { nome: "Saca-Bocado", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/saca bocado 1.webp" },
  { nome: "Saca-Bocado", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/saca bocado 2.webp" },
  { nome: "Saca-Bocado", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/saca bocado 3.webp" },
  { nome: "Satinsky", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/satinsky 1.jpg" },
  { nome: "Satinsky", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/satinsky 2.jpg" },
  { nome: "Satinsky", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/satinsky 3.jpg" },
  { nome: "Satinsky", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/satinsky 4.webp" },
  { nome: "Collins", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/collins 1.jpg" },
  { nome: "Collins", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/collin 2.webp" },
  { nome: "Collins", tempo: "Especiais", grupo: "Especiais", imagem: "imagens/collin 3.webp" },

  { nome: "Porta-Agulha Mayo-Hegar", tempo: "Porta-Agulhas", grupo: "Porta-Agulhas", imagem: "imagens/mayo hegar 1.png" },
  { nome: "Porta-Agulha Mayo-Hegar", tempo: "Porta-Agulhas", grupo: "Porta-Agulhas", imagem: "imagens/mayo hegar 2.webp" },
  { nome: "Porta-Agulha Mayo-Hegar", tempo: "Porta-Agulhas", grupo: "Porta-Agulhas", imagem: "imagens/mayo hegar 3.jpg" },
  { nome: "Porta-Agulha Mathieu", tempo: "Porta-Agulhas", grupo: "Porta-Agulhas", imagem: "imagens/mathieu 1.jpg" },
  { nome: "Porta-Agulha Mathieu", tempo: "Porta-Agulhas", grupo: "Porta-Agulhas", imagem: "imagens/mathieu 2.webp" }
];

const tempos = ["Preens√£o", "Hemostasia", "Exposi√ß√£o", "Especiais", "Porta-Agulhas"];
const difficultyTimes = { facil: 20, medio: 15, dificil: 10 };

let mode = "flashcard";
let difficulty = "medio";
let flashIndex = 0;
let flashFront = "imagem";
let quizPerguntas = [];
let quizIndex = 0;
let quizScore = 0;
let quizType = "tempo";
let tempoRestante = difficultyTimes[difficulty];
let timerRef = null;
let waitingNext = false;
let sessionCards = [];
let selectedGroup = "all";
let onlyFavorites = false;
let onlyLastSessionErrors = false;
let flashSeenInSession = new Set();
let currentQuizSessionErrorKeys = new Set();
let sessionAnswerMetrics = [];

const favoriteCards = JSON.parse(localStorage.getItem("favoriteCards")) || [];
const lastSessionErrorCards = JSON.parse(localStorage.getItem("lastSessionErrorCards")) || [];
const dailyStudyData = JSON.parse(localStorage.getItem("dailyStudyData")) || { goal: 30, progressByDate: {} };

const errosPorInstrumento = JSON.parse(localStorage.getItem("errosInstrumentos")) || {};
const historicoPontuacoes = JSON.parse(localStorage.getItem("historicoPontuacoes")) || [];

function saveStorage() {
  localStorage.setItem("errosInstrumentos", JSON.stringify(errosPorInstrumento));
  localStorage.setItem("historicoPontuacoes", JSON.stringify(historicoPontuacoes));
  localStorage.setItem("favoriteCards", JSON.stringify(favoriteCards));
  localStorage.setItem("lastSessionErrorCards", JSON.stringify(lastSessionErrorCards));
  localStorage.setItem("dailyStudyData", JSON.stringify(dailyStudyData));
}

function shuffle(array) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function getCardKey(item) {
  return item.imagem;
}

function isFavorite(item) {
  return favoriteCards.includes(getCardKey(item));
}

function toggleFavorite(item) {
  const key = getCardKey(item);
  const index = favoriteCards.indexOf(key);
  if (index >= 0) {
    favoriteCards.splice(index, 1);
  } else {
    favoriteCards.push(key);
  }
  saveStorage();
  if (mode === "lista") {
    renderListMode();
  } else if (mode === "quiz") {
    renderQuizQuestion();
  } else {
    renderFlashcard();
  }
  renderStats();
}

function setGroupFilter() {
  selectedGroup = document.getElementById("groupFilter").value;
  applySessionSize(true);
}

function toggleOnlyFavorites() {
  onlyFavorites = !onlyFavorites;
  document.getElementById("favoritesBtn").classList.toggle("toggle-active", onlyFavorites);
  applySessionSize(true);
}

function toggleOnlyLastErrors() {
  onlyLastSessionErrors = !onlyLastSessionErrors;
  document.getElementById("lastErrorsBtn").classList.toggle("toggle-active", onlyLastSessionErrors);
  applySessionSize(true);
}

function getTodayKey() {
  return new Date().toLocaleDateString("sv-SE");
}

function shiftDate(dateKey, deltaDays) {
  const [year, month, day] = dateKey.split("-").map(Number);
  const dt = new Date(year, month - 1, day);
  dt.setDate(dt.getDate() + deltaDays);
  return dt.toLocaleDateString("sv-SE");
}

function updateDailyGoal() {
  const value = Number(document.getElementById("dailyGoalInput").value);
  if (!Number.isNaN(value) && value > 0) {
    dailyStudyData.goal = Math.floor(value);
    saveStorage();
    renderStats();
  }
}

function recordAnswerMetric(correct, timedOut = false) {
  const totalTime = difficultyTimes[difficulty] || 15;
  const elapsed = timedOut ? totalTime : Math.max(0, totalTime - tempoRestante);
  sessionAnswerMetrics.push({ correct, timedOut, elapsed });
}

function buildQuizInsights() {
  if (sessionAnswerMetrics.length === 0) {
    return ["Sem dados suficientes para an√°lise nesta sess√£o."];
  }

  const insights = [];
  const total = sessionAnswerMetrics.length;
  const wrong = sessionAnswerMetrics.filter((item) => !item.correct);
  const correct = sessionAnswerMetrics.filter((item) => item.correct);
  const timeouts = sessionAnswerMetrics.filter((item) => item.timedOut).length;

  const avg = (arr) => arr.length ? arr.reduce((sum, item) => sum + item.elapsed, 0) / arr.length : 0;
  const avgWrong = avg(wrong);
  const avgCorrect = avg(correct);

  if (wrong.length > 0 && correct.length > 0 && avgWrong + 1 < avgCorrect) {
    insights.push("Voc√™ tende a errar quando responde r√°pido demais.");
  }

  if (timeouts / total >= 0.25) {
    insights.push("Parte dos erros veio por tempo esgotado; tente ajustar ritmo ou dificuldade.");
  }

  if (wrong.length > 0 && timeouts === 0 && avgWrong >= avgCorrect) {
    insights.push("Seus erros parecem mais por d√∫vida visual do que por pressa.");
  }

  if (insights.length === 0) {
    insights.push("Ritmo equilibrado na sess√£o. Continue o treino direcionado.");
  }

  return insights;
}

function addDailyProgress(amount = 1) {
  const today = getTodayKey();
  if (!dailyStudyData.progressByDate[today]) dailyStudyData.progressByDate[today] = 0;
  dailyStudyData.progressByDate[today] += amount;
  saveStorage();
}

function getDailyProgress() {
  const today = getTodayKey();
  return dailyStudyData.progressByDate[today] || 0;
}

function getCurrentStreak() {
  const goal = dailyStudyData.goal || 30;
  let cursor = getTodayKey();
  let streak = 0;

  while ((dailyStudyData.progressByDate[cursor] || 0) >= goal) {
    streak += 1;
    cursor = shiftDate(cursor, -1);
  }

  return streak;
}

function getFilteredBaseCards() {
  let filtered = [...instrumentos];

  if (selectedGroup !== "all") {
    filtered = filtered.filter((item) => item.tempo === selectedGroup);
  }

  if (onlyFavorites) {
    filtered = filtered.filter((item) => favoriteCards.includes(getCardKey(item)));
  }

  if (onlyLastSessionErrors) {
    filtered = filtered.filter((item) => lastSessionErrorCards.includes(getCardKey(item)));
  }

  return filtered;
}

function getRequestedSessionCount() {
  const select = document.getElementById("sessionSize");
  const value = select ? select.value : "all";
  if (value === "all") return instrumentos.length;
  const parsed = Number(value);
  if (Number.isNaN(parsed) || parsed <= 0) return instrumentos.length;
  return Math.min(parsed, instrumentos.length);
}

function buildSessionCards() {
  const filteredBase = getFilteredBaseCards();
  const count = Math.min(getRequestedSessionCount(), filteredBase.length);
  const shuffled = shuffle(filteredBase);
  return shuffled.slice(0, count);
}

function applySessionSize(refreshView) {
  sessionCards = buildSessionCards();
  flashIndex = 0;
  waitingNext = false;
  flashSeenInSession = new Set();

  if (!refreshView) return;

  if (mode === "quiz") {
    startQuiz();
  } else if (mode === "lista") {
    renderListMode();
  } else {
    renderFlashcard();
  }

  renderStats();
}

function imageHtml(item, className = "visual") {
  const safeImage = item.imagem.replace(/'/g, "\\'");
  return `<div class="${className}"><img src="${item.imagem}" alt="${item.nome}" onclick="openZoom('${safeImage}')" onerror="this.parentElement.textContent='${item.nome}'; this.remove();"></div>`;
}

function openZoom(src) {
  document.getElementById("zoomImg").src = src;
  document.getElementById("zoomOverlay").classList.add("open");
}

function closeZoom() {
  document.getElementById("zoomOverlay").classList.remove("open");
}

function startStudy(initialMode) {
  document.getElementById("dailyGoalInput").value = dailyStudyData.goal || 30;
  applySessionSize(false);
  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("studyArea").classList.remove("hidden");
  setMode(initialMode);
}

function resetAnalise() {
  const confirmar = confirm("Deseja resetar toda a an√°lise? Isso limpa hist√≥rico de pontua√ß√µes e erros por instrumento.");
  if (!confirmar) return;

  Object.keys(errosPorInstrumento).forEach((key) => delete errosPorInstrumento[key]);
  historicoPontuacoes.length = 0;
  favoriteCards.length = 0;
  lastSessionErrorCards.length = 0;
  dailyStudyData.progressByDate = {};
  localStorage.removeItem("errosInstrumentos");
  localStorage.removeItem("historicoPontuacoes");
  localStorage.removeItem("favoriteCards");
  localStorage.removeItem("lastSessionErrorCards");
  localStorage.removeItem("dailyStudyData");

  quizScore = 0;
  quizIndex = 0;

  renderStats();

  if (mode === "quiz") {
    startQuiz();
  } else if (mode === "lista") {
    renderListMode();
  } else {
    renderFlashcard();
  }
}

document.addEventListener("keydown", (event) => {
  if (event.key === "Escape") closeZoom();
});

function setMode(newMode) {
  mode = newMode;
  clearTimer();
  waitingNext = false;

  document.getElementById("flashModeBtn").classList.toggle("active", mode === "flashcard");
  document.getElementById("quizModeBtn").classList.toggle("active", mode === "quiz");
  document.getElementById("listModeBtn").classList.toggle("active", mode === "lista");
  document.getElementById("difficultyGroup").classList.toggle("hidden", mode !== "quiz");

  if (mode === "quiz") {
    document.getElementById("timer").classList.remove("hidden");
    startQuiz();
  } else if (mode === "lista") {
    document.getElementById("timer").classList.add("hidden");
    renderListMode();
  } else {
    document.getElementById("timer").classList.add("hidden");
    renderFlashcard();
  }

  renderStats();
}

function setDifficulty(level) {
  difficulty = level;
  document.getElementById("facilBtn").classList.toggle("active", level === "facil");
  document.getElementById("medioBtn").classList.toggle("active", level === "medio");
  document.getElementById("dificilBtn").classList.toggle("active", level === "dificil");
  if (mode === "quiz") startQuiz();
}

function setQuizType() {
  quizType = document.getElementById("quizType").value;
  if (mode === "quiz") startQuiz();
}

function nextFlash() {
  flashIndex = (flashIndex + 1) % sessionCards.length;
  flashFront = "imagem";
  renderFlashcard();
}

function prevFlash() {
  flashIndex = (flashIndex - 1 + sessionCards.length) % sessionCards.length;
  flashFront = "imagem";
  renderFlashcard();
}

function flipFlash() {
  flashFront = flashFront === "imagem" ? "verso" : "imagem";
  renderFlashcard();
}

function renderFlashcard() {
  const cardEl = document.getElementById("card");
  const item = sessionCards[flashIndex];

  if (!item) {
    cardEl.innerHTML = `<p class="desc">Nenhum card dispon√≠vel nesta sess√£o.</p>`;
    updateProgress(0);
    return;
  }

  const favoriteLabel = isFavorite(item) ? "‚òÖ Favorito" : "‚òÜ Favoritar";

  if (flashFront === "imagem") {
    cardEl.innerHTML = `
      ${imageHtml(item)}
      <h2 class="title">Flashcard</h2>
      <p class="desc">Frente: imagem</p>
      <div class="controls">
        <button class="action-btn" type="button" onclick="prevFlash()">Anterior</button>
        <button class="action-btn" type="button" onclick="flipFlash()">Virar</button>
        <button class="action-btn" type="button" onclick="toggleFavorite(sessionCards[flashIndex])">${favoriteLabel}</button>
        <button class="action-btn" type="button" onclick="nextFlash()">Pr√≥ximo</button>
      </div>
    `;
  } else {
    cardEl.innerHTML = `
      ${imageHtml(item)}
      <h2 class="title">${item.nome}</h2>
      <p class="desc">Tempo: ${item.tempo}</p>
      <p class="desc">Grupo: ${item.grupo}</p>
      <div class="controls">
        <button class="action-btn" type="button" onclick="prevFlash()">Anterior</button>
        <button class="action-btn" type="button" onclick="flipFlash()">Voltar</button>
        <button class="action-btn" type="button" onclick="toggleFavorite(sessionCards[flashIndex])">${favoriteLabel}</button>
        <button class="action-btn" type="button" onclick="nextFlash()">Pr√≥ximo</button>
      </div>
    `;
  }

  const key = getCardKey(item);
  if (!flashSeenInSession.has(key)) {
    flashSeenInSession.add(key);
    addDailyProgress(1);
  }

  updateProgress(((flashIndex + 1) / sessionCards.length) * 100);
}

function renderListMode() {
  const cardEl = document.getElementById("card");
  cardEl.innerHTML = `<div class="list-grid" id="listGrid"></div>`;
  const grid = document.getElementById("listGrid");

  sessionCards.forEach((item, index) => {
    const el = document.createElement("div");
    el.className = "list-item";
    el.innerHTML = `
      <div class="front">Frente</div>
      ${imageHtml(item, "mini")}
      <div class="back">Verso</div>
      <h4>${item.nome}</h4>
      <p>Tempo: ${item.tempo}</p>
      <p>Grupo: ${item.grupo}</p>
      <button class="action-btn" type="button" onclick="toggleFavorite(sessionCards[${index}])">${isFavorite(item) ? "‚òÖ Favorito" : "‚òÜ Favoritar"}</button>
    `;
    grid.appendChild(el);
  });

  updateProgress(100);
}

function registrarErro(nome) {
  errosPorInstrumento[nome] = (errosPorInstrumento[nome] || 0) + 1;
}

function getAdaptivePool() {
  const pool = [];
  sessionCards.forEach((item) => {
    const peso = 1 + Math.min(errosPorInstrumento[item.nome] || 0, 6);
    for (let i = 0; i < peso; i++) pool.push(item);
  });
  return pool;
}

function startQuiz() {
  clearTimer();
  waitingNext = false;
  quizScore = 0;
  quizIndex = 0;
  currentQuizSessionErrorKeys = new Set();
  sessionAnswerMetrics = [];
  quizPerguntas = shuffle(shuffle(getAdaptivePool()).slice(0, sessionCards.length));
  renderQuizQuestion();
  renderStats();
}

function renderQuizQuestion() {
  if (quizIndex >= quizPerguntas.length) {
    showQuizFinal();
    return;
  }

  const item = quizPerguntas[quizIndex];
  const isNomeQuiz = quizType === "nome";
  const correta = isNomeQuiz ? item.nome : item.tempo;
  const universo = isNomeQuiz
    ? Array.from(new Set(sessionCards.map((card) => card.nome)))
    : tempos;

  const distratores = shuffle(universo.filter((valor) => valor !== correta)).slice(0, 3);
  const opcoes = shuffle([correta, ...distratores]);
  const perguntaTxt = isNomeQuiz
    ? "Qual o nome deste instrumental?"
    : "Em qual tempo cir√∫rgico √© usado?";

  document.getElementById("card").innerHTML = `
    ${imageHtml(item)}
    <h2 class="title">${perguntaTxt}</h2>
    <div class="options" id="options"></div>
    <div class="feedback" id="feedback"></div>
    <div class="controls"><button class="action-btn hidden" id="nextBtn" type="button" onclick="nextQuizQuestion()">Pr√≥xima</button></div>
  `;

  const optionsDiv = document.getElementById("options");
  opcoes.forEach((tempo) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "option-btn";
    btn.textContent = tempo;
    btn.onclick = () => checkQuizAnswer(btn, tempo);
    optionsDiv.appendChild(btn);
  });

  updateProgress((quizIndex / quizPerguntas.length) * 100);
  startTimer();
  renderStats();
}

function startTimer() {
  clearTimer();
  tempoRestante = difficultyTimes[difficulty];
  const timerEl = document.getElementById("timer");
  timerEl.textContent = `Tempo: ${tempoRestante}s`;
  timerRef = setInterval(() => {
    tempoRestante -= 1;
    timerEl.textContent = `Tempo: ${tempoRestante}s`;
    if (tempoRestante <= 0) {
      clearTimer();
      handleTimeout();
    }
  }, 1000);
}

function clearTimer() {
  if (timerRef) {
    clearInterval(timerRef);
    timerRef = null;
  }
}

function lockOptions() {
  document.querySelectorAll(".option-btn").forEach((b) => b.disabled = true);
}

function checkQuizAnswer(button, resposta) {
  if (waitingNext) return;
  waitingNext = true;
  clearTimer();

  const item = quizPerguntas[quizIndex];
  const correta = quizType === "nome" ? item.nome : item.tempo;
  const feedbackEl = document.getElementById("feedback");
  lockOptions();

  if (resposta === correta) {
    quizScore += 1;
    recordAnswerMetric(true, false);
    button.classList.add("correct");
    feedbackEl.textContent = "‚úî Correto!";
  } else {
    registrarErro(item.nome);
    currentQuizSessionErrorKeys.add(getCardKey(item));
    recordAnswerMetric(false, false);
    button.classList.add("wrong");
    feedbackEl.textContent = `‚úñ Errado! Resposta correta: ${correta}`;
    document.querySelectorAll(".option-btn").forEach((b) => {
      if (b.textContent === correta) b.classList.add("correct");
    });
  }

  document.getElementById("nextBtn").classList.remove("hidden");
  addDailyProgress(1);
  renderStats();
}

function handleTimeout() {
  if (waitingNext) return;
  waitingNext = true;

  const item = quizPerguntas[quizIndex];
  const correta = quizType === "nome" ? item.nome : item.tempo;
  registrarErro(item.nome);
  currentQuizSessionErrorKeys.add(getCardKey(item));
  recordAnswerMetric(false, true);

  lockOptions();
  document.querySelectorAll(".option-btn").forEach((b) => {
    if (b.textContent === correta) b.classList.add("correct");
  });

  document.getElementById("feedback").textContent = `‚è∞ Tempo esgotado! Resposta correta: ${correta}`;
  document.getElementById("nextBtn").classList.remove("hidden");
  addDailyProgress(1);
  renderStats();
}

function nextQuizQuestion() {
  waitingNext = false;
  quizIndex += 1;
  renderQuizQuestion();
}

function instrumentoMaisErrado() {
  let nome = "Nenhum";
  let totalErros = 0;
  Object.keys(errosPorInstrumento).forEach((instrumento) => {
    if (errosPorInstrumento[instrumento] > totalErros) {
      nome = instrumento;
      totalErros = errosPorInstrumento[instrumento];
    }
  });
  return `${nome} (${totalErros} erros)`;
}

function saveHistoricoFinal() {
  const total = quizPerguntas.length;
  const percentual = total ? Number(((quizScore / total) * 100).toFixed(1)) : 0;
  historicoPontuacoes.push({ data: new Date().toLocaleString("pt-BR"), dificuldade: difficulty, acertos: quizScore, total, percentual });
  if (historicoPontuacoes.length > 12) historicoPontuacoes.shift();

  lastSessionErrorCards.length = 0;
  currentQuizSessionErrorKeys.forEach((key) => lastSessionErrorCards.push(key));

  saveStorage();
}

function showQuizFinal() {
  clearTimer();
  saveHistoricoFinal();
  document.getElementById("timer").classList.add("hidden");

  const total = quizPerguntas.length;
  const percentual = total ? ((quizScore / total) * 100).toFixed(1) : "0.0";
  const insights = buildQuizInsights();
  const insightsHtml = insights.map((line) => `<p class="desc">‚Ä¢ ${line}</p>`).join("");

  document.getElementById("card").innerHTML = `
    <h2 class="title">Resultado Final</h2>
    <p class="desc">Voc√™ acertou ${quizScore} de ${total}</p>
    <p class="desc">Percentual: ${percentual}%</p>
    <p class="desc">Dificuldade: ${difficulty}</p>
    <h3 class="title">Instrumento com mais erro</h3>
    <p class="desc">${instrumentoMaisErrado()}</p>
    <h3 class="title">An√°lise da sess√£o</h3>
    ${insightsHtml}
    <div class="controls">
      <button class="action-btn" type="button" onclick="startQuiz()">Refazer Quiz</button>
      <button class="action-btn" type="button" onclick="setMode('lista')">Ver Lista</button>
    </div>
  `;

  updateProgress(100);
  renderStats();
}

function renderStats() {
  const ultimo = historicoPontuacoes[historicoPontuacoes.length - 1];
  const historicoTxt = ultimo ? `√öltimo quiz: ${ultimo.acertos}/${ultimo.total} (${ultimo.percentual}%)` : "√öltimo quiz: sem hist√≥rico";
  const totalSessao = sessionCards.length;
  const metaAtual = getDailyProgress();
  const metaTotal = dailyStudyData.goal || 30;
  const streak = getCurrentStreak();
  const metaConcluida = metaAtual >= metaTotal;
  const metaBadge = metaConcluida ? "‚úÖ" : "üïí";
  const streakBadge = streak > 0 ? "üî•" : "‚≠ï";
  document.getElementById("dailyGoalChip").textContent = `üéØ Meta di√°ria: ${metaTotal} cards`;

  const atual = mode === "quiz"
    ? `Quiz: ${quizScore}/${quizPerguntas.length || totalSessao || 0}`
    : mode === "lista"
      ? `Lista: ${totalSessao} instrumentais`
      : `Flashcards: ${totalSessao ? flashIndex + 1 : 0}/${totalSessao}`;

  document.getElementById("stats").innerHTML = `<span>${atual}</span><span>${historicoTxt}</span><span>${metaBadge} Meta di√°ria: ${metaAtual}/${metaTotal}</span><span>${streakBadge} Streak: ${streak} dia(s)</span>`;
}

function updateProgress(v) {
  document.getElementById("progressBar").style.width = `${Math.max(0, Math.min(100, v)).toFixed(1)}%`;
}

setDifficulty("medio");
renderStats();
</script>
</body>
</html>