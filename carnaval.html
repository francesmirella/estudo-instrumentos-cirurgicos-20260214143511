<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Instrumentos Cirúrgicos</title>
<style>
* { box-sizing: border-box; }

body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #0f4c81, #1e88e5);
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.container {
  background: white;
  width: min(620px, 100%);
  padding: 24px;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  text-align: center;
}

h2 {
  margin: 0 0 8px;
  color: #0f4c81;
}

.subtitle {
  margin: 0 0 14px;
  color: #406e98;
}

.difficulty {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 14px;
}

.difficulty-btn {
  border: none;
  border-radius: 10px;
  padding: 7px 12px;
  cursor: pointer;
  background: #e3f2fd;
  color: #0f4c81;
  font-weight: 700;
}

.difficulty-btn.active {
  background: #0f4c81;
  color: white;
}

.progress-container {
  width: 100%;
  height: 10px;
  background: #e0e0e0;
  border-radius: 10px;
  margin-bottom: 14px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: #1e88e5;
  transition: width 0.4s ease;
}

.stats {
  margin-bottom: 8px;
  color: #0f4c81;
  font-weight: 600;
  font-size: 14px;
}

.timer {
  font-weight: bold;
  margin-bottom: 10px;
  color: #e53935;
}

.score {
  margin-bottom: 10px;
  font-weight: bold;
  color: #0f4c81;
}

.visual {
  width: 240px;
  height: 170px;
  margin: 0 auto 12px;
  border-radius: 12px;
  background: #f1f7ff;
  border: 1px solid #d1e4f7;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #4d7397;
  font-weight: 700;
  padding: 12px;
}

.visual img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.question {
  font-size: 17px;
  margin-bottom: 15px;
  color: #0f4c81;
}

.option {
  display: block;
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 10px;
  border: none;
  background: #e3f2fd;
  cursor: pointer;
  transition: 0.3s;
  font-size: 15px;
  color: #0f4c81;
  font-weight: 600;
}

.option:hover {
  background: #bbdefb;
}

.correct {
  background: #4caf50 !important;
  color: white !important;
}

.wrong {
  background: #e53935 !important;
  color: white !important;
}

.feedback {
  margin-top: 10px;
  font-weight: bold;
  min-height: 25px;
  color: #0f4c81;
}

.next-btn {
  margin-top: 10px;
  padding: 8px 20px;
  border: none;
  border-radius: 10px;
  background: #0f4c81;
  color: white;
  cursor: pointer;
  display: none;
  font-weight: 700;
}
</style>
</head>
<body>

<div class="container" id="container">
  <h2>Quiz - Tempo Cirúrgico</h2>
  <p class="subtitle">Simulação prática com treino adaptativo por erros.</p>

  <div class="difficulty">
    <button id="facilBtn" class="difficulty-btn" type="button" onclick="setDificuldade('facil')">Fácil (20s)</button>
    <button id="medioBtn" class="difficulty-btn active" type="button" onclick="setDificuldade('medio')">Médio (15s)</button>
    <button id="dificilBtn" class="difficulty-btn" type="button" onclick="setDificuldade('dificil')">Difícil (10s)</button>
  </div>

  <div class="stats" id="stats"></div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div class="timer" id="timer">Tempo: 15s</div>
  <div class="score" id="score">Pontuação: 0</div>

  <div class="visual" id="instrumentVisual"></div>

  <div class="question" id="question"></div>
  <div id="options"></div>
  <div class="feedback" id="feedback"></div>

  <button class="next-btn" id="nextBtn" type="button" onclick="nextQuestion()">Próxima</button>
</div>

<script>
const instrumentos = [
  { nome: "Pinça Kelly", tempo: "Hemostasia", imagem: "imagens/kelly.jpg" },
  { nome: "Tesoura Metzenbaum", tempo: "Diérese", imagem: "imagens/metzenbaum.jpg" },
  { nome: "Tesoura Mayo", tempo: "Diérese", imagem: "imagens/mayo.jpg" },
  { nome: "Pinça Halstead", tempo: "Hemostasia", imagem: "imagens/halstead.jpg" },
  { nome: "Farabeuf", tempo: "Exposição", imagem: "imagens/farabeuf.jpg" },
  { nome: "Deaver", tempo: "Exposição", imagem: "imagens/deaver.jpg" },
  { nome: "Gosset", tempo: "Exposição", imagem: "imagens/gosset.jpg" },
  { nome: "Porta-agulha Mayo-Hegar", tempo: "Síntese", imagem: "imagens/mayohegar.jpg" },
  { nome: "Mathieu", tempo: "Síntese", imagem: "imagens/mathieu.jpg" },
  { nome: "Allis", tempo: "Especial", imagem: "imagens/allis.jpg" },
  { nome: "Babcock", tempo: "Especial", imagem: "imagens/babcock.jpg" },
  { nome: "Duval", tempo: "Especial", imagem: "imagens/duval.jpg" },
  { nome: "Satinsky", tempo: "Especial", imagem: "imagens/satinsky.jpg" },
  { nome: "Backaus", tempo: "Especial", imagem: "imagens/backaus.jpg" }
];

const tempos = ["Diérese", "Hemostasia", "Exposição", "Síntese", "Especial"];
const temposDificuldade = { facil: 20, medio: 15, dificil: 10 };

let dificuldade = "medio";
let tempoPorPergunta = temposDificuldade[dificuldade];

let currentQuestion = 0;
let score = 0;
let perguntas = [];
let tempoRestante = tempoPorPergunta;
let intervalo = null;
let aguardandoProxima = false;

let errosPorInstrumento = JSON.parse(localStorage.getItem("errosInstrumentos")) || {};
let historicoPontuacoes = JSON.parse(localStorage.getItem("historicoPontuacoes")) || [];

function saveStorage() {
  localStorage.setItem("errosInstrumentos", JSON.stringify(errosPorInstrumento));
  localStorage.setItem("historicoPontuacoes", JSON.stringify(historicoPontuacoes));
}

function shuffle(array) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function instrumentoMaisErrado() {
  let nome = "Nenhum";
  let total = 0;

  Object.keys(errosPorInstrumento).forEach((instrumento) => {
    if (errosPorInstrumento[instrumento] > total) {
      total = errosPorInstrumento[instrumento];
      nome = instrumento;
    }
  });

  return `${nome} (${total} erros)`;
}

function updateStats() {
  const ultima = historicoPontuacoes[historicoPontuacoes.length - 1];
  const ultimoTxt = ultima
    ? `Último quiz: ${ultima.acertos}/${ultima.total} (${ultima.percentual}%)`
    : "Último quiz: sem histórico";

  document.getElementById("stats").textContent = `${ultimoTxt} | Mais erro: ${instrumentoMaisErrado()}`;
}

function registrarErro(nome) {
  errosPorInstrumento[nome] = (errosPorInstrumento[nome] || 0) + 1;
  saveStorage();
}

function getAdaptivePool() {
  const pool = [];
  instrumentos.forEach((item) => {
    const peso = 1 + Math.min(errosPorInstrumento[item.nome] || 0, 6);
    for (let i = 0; i < peso; i++) {
      pool.push(item);
    }
  });
  return pool;
}

function updateProgress() {
  const progress = (currentQuestion / perguntas.length) * 100;
  document.getElementById("progressBar").style.width = progress.toFixed(1) + "%";
}

function setVisual(item) {
  const visual = document.getElementById("instrumentVisual");
  visual.innerHTML = `<img src="${item.imagem}" alt="${item.nome}" onerror="this.parentElement.textContent='${item.nome}'; this.remove();">`;
}

function clearTimer() {
  if (intervalo) {
    clearInterval(intervalo);
    intervalo = null;
  }
}

function startTimer() {
  clearTimer();
  tempoRestante = tempoPorPergunta;
  document.getElementById("timer").textContent = `Tempo: ${tempoRestante}s`;

  intervalo = setInterval(() => {
    tempoRestante -= 1;
    document.getElementById("timer").textContent = `Tempo: ${tempoRestante}s`;

    if (tempoRestante <= 0) {
      clearTimer();
      handleTimeout();
    }
  }, 1000);
}

function bloquearRespostas() {
  clearTimer();
  const allButtons = document.querySelectorAll(".option");
  allButtons.forEach((btn) => {
    btn.disabled = true;
  });
}

function showNextButton() {
  document.getElementById("nextBtn").style.display = "inline-block";
}

function hideNextButton() {
  document.getElementById("nextBtn").style.display = "none";
}

function handleTimeout() {
  if (aguardandoProxima) return;
  aguardandoProxima = true;

  const item = perguntas[currentQuestion];
  registrarErro(item.nome);
  bloquearRespostas();

  const allButtons = document.querySelectorAll(".option");
  allButtons.forEach((btn) => {
    if (btn.innerText === item.tempo) {
      btn.classList.add("correct");
    }
  });

  document.getElementById("feedback").innerText = `⏰ Tempo esgotado! Resposta correta: ${item.tempo}`;
  showNextButton();
  updateStats();
}

function loadQuestion() {
  if (currentQuestion >= perguntas.length) {
    showFinal();
    return;
  }

  aguardandoProxima = false;
  const questionData = perguntas[currentQuestion];
  setVisual(questionData);

  document.getElementById("question").innerText = "Em qual tempo cirúrgico é usado este instrumento?";

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";
  document.getElementById("feedback").innerText = "";
  hideNextButton();

  let alternativas = [questionData.tempo];

  while (alternativas.length < 4) {
    const tempoAleatorio = tempos[Math.floor(Math.random() * tempos.length)];
    if (!alternativas.includes(tempoAleatorio)) {
      alternativas.push(tempoAleatorio);
    }
  }

  alternativas = shuffle(alternativas);

  alternativas.forEach((opcao) => {
    const button = document.createElement("button");
    button.innerText = opcao;
    button.classList.add("option");
    button.type = "button";
    button.onclick = () => checkAnswer(button, opcao);
    optionsDiv.appendChild(button);
  });

  updateProgress();
  startTimer();
}

function checkAnswer(button, resposta) {
  if (aguardandoProxima) return;
  aguardandoProxima = true;

  bloquearRespostas();

  const correta = perguntas[currentQuestion].tempo;
  const nomeInstrumento = perguntas[currentQuestion].nome;
  const allButtons = document.querySelectorAll(".option");

  if (resposta === correta) {
    button.classList.add("correct");
    score += 1;
    document.getElementById("feedback").innerText = "✔ Correto!";
  } else {
    registrarErro(nomeInstrumento);
    button.classList.add("wrong");
    document.getElementById("feedback").innerText = `✖ Errado! Resposta correta: ${correta}`;

    allButtons.forEach((btn) => {
      if (btn.innerText === correta) {
        btn.classList.add("correct");
      }
    });
  }

  document.getElementById("score").innerText = `Pontuação: ${score}`;
  updateStats();
  showNextButton();
}

function nextQuestion() {
  currentQuestion += 1;

  if (currentQuestion < perguntas.length) {
    loadQuestion();
  } else {
    showFinal();
  }
}

function saveHistoricoFinal() {
  const total = perguntas.length;
  const percentual = total ? Number(((score / total) * 100).toFixed(1)) : 0;

  historicoPontuacoes.push({
    data: new Date().toLocaleString("pt-BR"),
    dificuldade,
    acertos: score,
    total,
    percentual
  });

  if (historicoPontuacoes.length > 12) {
    historicoPontuacoes.shift();
  }

  saveStorage();
}

function showFinal() {
  clearTimer();
  saveHistoricoFinal();
  updateStats();

  const total = perguntas.length;
  const percentual = total ? ((score / total) * 100).toFixed(1) : "0.0";

  document.getElementById("container").innerHTML = `
    <h2>Resultado Final</h2>
    <p>Você acertou ${score} de ${total}</p>
    <p>Percentual: ${percentual}%</p>
    <p>Dificuldade: ${dificuldade}</p>
    <h3>Instrumento que você mais erra:</h3>
    <p>${instrumentoMaisErrado()}</p>
    <button onclick="location.reload()" class="next-btn" style="display:inline-block" type="button">Refazer Quiz</button>
  `;
}

function startQuiz() {
  clearTimer();
  currentQuestion = 0;
  score = 0;
  aguardandoProxima = false;

  const pool = shuffle(getAdaptivePool()).slice(0, instrumentos.length);
  perguntas = shuffle(pool);

  document.getElementById("score").innerText = "Pontuação: 0";
  document.getElementById("progressBar").style.width = "0%";
  updateStats();
  loadQuestion();
}

function setDificuldade(nivel) {
  dificuldade = nivel;
  tempoPorPergunta = temposDificuldade[nivel];

  document.getElementById("facilBtn").classList.toggle("active", nivel === "facil");
  document.getElementById("medioBtn").classList.toggle("active", nivel === "medio");
  document.getElementById("dificilBtn").classList.toggle("active", nivel === "dificil");

  startQuiz();
}

updateStats();
startQuiz();
</script>

</body>
</html>